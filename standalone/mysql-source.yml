---
- name: Install Mysql From Source Code
  hosts:
    - 127.0.0.1
  remote_user: yan
  sudo: yes
  connection: local
  vars: 
    basedir: /opt/mysql
  pre_tasks:
    - name: Install SELinux Python Binding
      yum: name=libselinux-python  state=present
  
    - name: Remove mysql 
      yum: name={{ item }}  state=absent
      with_items:
        - mysql
        - mysql-server
        - mysql-libs
 
  tasks:
    - name: Install Development Tools
      yum: name={{ item }}   state=present
      with_items:
        - gcc
        - gcc-c++
        - make
        - autoconf
        - cmake
        
    - name: Install necessary libraries for compiling
      yum: name={{ item }}  state=present
      with_items:
        - zlib-devel
        - ncurses-devel
        - openssl-devel

    - name: Create directory for Compliing MySQL
      command: /bin/mkdir /usr/src/yan
               creates=/usr/src/yan

    - name: Setting Porper Modes
      file: path=/usr/src/yan
            state=directory
            owner=yan
            group=yan

    - name: Copy Google Mock(gmock)
      copy: src=/home/yan/software/mysql/gmock-1.6.0.zip
            dest=/usr/src/yan

    - name: Copy MySQL Source Code
      copy: src=/home/yan/software/mysql/mysql-5.6.20.tar.gz
            dest=/usr/src/yan

    - name: Copy Post Install Securing Script
      copy: src=/home/yan/software/mysql/secure.sql
            dest=/opt

    - name: Untar MySQL Source Code
      command: /bin/tar xzvf  mysql-5.6.20.tar.gz -C /usr/src/yan
               chdir=/usr/src/yan
               creates=/usr/src/yan/mysql-5.6.20

    - name: Configuration MySQL Source Code
      command: /usr/bin/cmake .  -DCMAKE_INSTALL_PREFIX=/opt/mysql -DSYSCONFDIR=/opt/mysql/data  -DMYSQL_DATADIR=/opt/mysql/data  -DMYSQL_UNIX_ADDR=/opt/mysql/data/mysql.sock  -DWITH_INNOBASE_STORAGE_ENGINE=1  -DWITH_PARTITION_STORAGE_ENGINE=1  -DWITH_ARCHIVE_STORAGE_ENGINE=1  -DWITH_BLACKHOLE_STORAGE_ENGINE=1  -DWITH_FEDERATED_STORAGE_ENGINE=1  -DWITH_PERFSCHEMA_STORAGE_ENGINE=1  -DENABLED_LOCAL_INFILE=1  -DMYSQL_TCP_PORT=3306  -DWITH_EXTRA_CHARSETS=all  -DWITH_DEBUG=0  -DENABLE_DEBUG_SYNC=0  -DWITH_SSL=bundled  -DWITH_ZLIB=bundled  -DWITH_READLINE=1  -DZLIB_INCLUDE_DIR=/usr  -DWITH_READLINE=1  -DWITH_GMOCK=/usr/src/yan/gmock-1.6.0.zip
               chdir=/usr/src/yan/mysql-5.6.20

    - name: Compliing MySQL Source Code
      command: make -j2
               chdir=/usr/src/yan/mysql-5.6.20

    - name: Installing MySQL 
      command: make install
               chdir=/usr/src/yan/mysql-5.6.20

    - name: Install MySQL Startup Script
      template: src=/home/yan/software/mysql/mysql.server.j2
                dest=/etc/init.d/mysql
                owner=root
                group=root
                mode=0755

    - name: Create User & Group For MySQL
      user: name=mysql 
            home=/opt/mysql
            createhome=no 
            shell=/bin/false

    - name: Setting MySQL Installation Directory Owner to mysql
      file: path=/opt/mysql
            owner=mysql
            group=mysql
            recurse=yes

    - name: Initialize mysql database
      command: scripts/mysql_install_db --user=mysql
               chdir=/opt/mysql

    - name: Start Mysql Service
      service: name=mysql  state=started

    - name: Wait service to startup
      wait_for: port=3306

    
    - name: Securing mysql
      shell: bin/mysql -uroot </opt/secure.sql
             chdir=/opt/mysql

    - pause: prompt="ALL DONE! push enter key to quie"

